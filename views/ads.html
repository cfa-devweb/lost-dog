{% extends "layouts/base.html" %}
{% block css %}
<style>
  #select {
    margin-bottom: 20px;
  }
</style>
{% endblock %}
{% block content %}
<main>
  <div class="container">
    <div class="row justify-content-md-center">
      <div class="col-md-auto">

        <h1 class="titre-annonces size-h1">Toutes les annonces</h1>

        <form id="form" onsubmit="searchData(this)">
          <div class="input-group">

            <input id="input" type="text" class="form-control" placeholder="Rechercher..."
              aria-label="Input group example" aria-describedby="btnGroupAddon" name="search">
            <button type="submit" class="btn btn-secondary">Search</button>
          </div>
        </form>
      </div>
    </div>
    <div class="row justify-content-md-center">
      <div class="col-md-auto" id="select">
        <select id="select">
          <option value>Catégorie</option>
          <option id="chien" name="chien" value>Chien</option>
          <option id="chat" name="chat" value>Chat</option>
          <option id="oiseaux" name="oiseaux" value>Oiseaux</option>
          <option id="autres" name="autres" value>Autres</option>
        </select>

        <select id="select">
          <option value>Situation</option>
          <option id="perdu" name="perdu" value>Perdu</option>
          <option id="trouve" name="trouve" value>Trouvé</option>
          <option id="a-adopter" name="a-adopter" value>A adopter</option>
        </select>
      </div>
    </div>
  </div>

  <div class="container" id="container_cards" >
    <div class="row"  id="insertCard" style="overflow: auto;">
      {% for ad in ads %}
      <div class="col-4">
        <div class="card" style="width: 18rem;">
          <img src="{{ ad.image }}" class="card-img-top" alt="{{ ad.title }}">
          <div class="card-body">
            <h5 class="card-title">{{ ad.title }}</h5>
            <p class="card-text">{{ ad.description }}</p>
            <a href="#" class="btn btn-primary">Go somewhere</a>
            <button type="button" class="btn btn-secondary" name="found" disabled></button>
            <button type="button" class="btn btn-info" name="lost" disabled></button>
            <button type="button" class="btn btn-success" name="adopted" disabled></button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</main>
{% endblock %}

{% block js %}
<script type="text/javascript">

  var block = document.getElementById('container_cards');
  var test = document.getElementById("insertCard");

  document.getElementById('form').addEventListener('submit', function (event) {
    event.preventDefault();
    searchData(event.target.search.value);
  });

  function searchData(search) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', "/api/annonces", true);
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4 && this.status === 200) {
        var response = JSON.parse(xhr.responseText);
        displayInfo(response);
      }
    };
    xhr.send();
  }

  function displayInfo(data) {
    block.innerHTML = '';
    data.ads.forEach(function (ad) {
      var info = document.createElement('div');
      info.innerHTML = `
      <div class="container">
        <div class="row">
          {% for ad in ads %}
          <div class="col-4" id="insertCard">
            <div class="card" style="width: 18rem;">
              <img src="${ad.image}" class="card-img-top" alt="${ad.title}">
                <div class="card-body">
                  <h5 class="card-title">${ad.title}</h5>
                  <p class="card-text">${ad.description}</p>
                  <a href="#" class="btn btn-primary">Go somewhere</a>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      `;
      block.appendChild(info);
    });
  }

  function loadCard() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        cardAds(JSON.parse(this.responseText));
      }
    };
    xhttp.open("GET", "/api/annonces", true);
    xhttp.send();
  };

  function cardAds(data) {
    data.ads.forEach(post => {
      test.innerHTML += `
      <div class="col-4">
        <div class="card" style="width: 18rem;">
            <img src="${post.image}" class="card-img-top" alt="${post.title}">
            <div class="card-body">
              <h5 class="card-title">${post.title}</h5>
              <p class="card-text">${post.description}</p>
              <a href="#" class="btn btn-primary">Go somewhere</a>
            </div>
          </div>
        </div>
        `
    });
  }

  document.addEventListener('scroll', function(event) {
    if(window.pageYOffset + window.innerHeight >= document.body.offsetHeight) {
      loadCard();
    }
  });

</script>
{% endblock %}
